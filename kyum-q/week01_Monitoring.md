# 모니터링 필요성

## 왜 필요해?

런칭 이후에는 고객이 100명이라도 안정적인(High Availability)서비스를 운영해야 하는 것이 백엔드 개발자의 임무이다.

안정적인 서비스를 운영하기 위해서는 체계적인 모니터링 필수라고 하는데 그마저도 쉽지 않습니다. 가장 큰 문제는 (장애가 터지기 전까지) 무엇을 모니터링 해야 하는지조차 모른다는 것이고, 당장 개발해야할 것들이
산더미처럼 쌓여있는데 사람도 부족한 것도 문제입니다.

그러니 시각화가 잘되있는 모니터링 툴을 사용해서 모니터링을 진행해야한다. 그러면 문제가 발생했을 때 빠른 대처, 문제가 발생하기 전에 문제 파악 후 해결이 가능하다.

> 참고 - [DevOps 팀을 위한 모니터링 팁](https://ridicorp.com/story/monitoring-howto/)

### 실제로 겪은 문제 상황

백엔드 서버에 문제가 생겨 서버 서비스가 종료되었다. 하지만 모니터링 시스템이 없었던 시절이라 프론트엔드 개발자가 서버에서 500에러가 발생한다며 확인을 요청해서 알게 되었다. 언제부터 서비스가 종료되었는지 확인할
수 있는 방안이 없었다.
그리고 무슨 이유로 서버가 종료되었는지 파악하기 위해 로그 파일을 열어보니 너무 많은 로그가 작성되어있어 필요한 로그를 찾는데도 시간이 꽤 소요되었다.

## 목표

#### 1. 시간 측면에서 측정되는 주요 메트릭을 최소화하여 고가용성 달성

- _TTD(감지_시간): 성능 또는 기타 문제가 발생하면 문제에 대한 풍부한 진단 데이터가 자동화된 모니터링을 통해 개발 팀에 다시 공급됩니다.
- _TTM(완화_시간): DevOps 팀은 사용자가 더 이상 영향을 받지 않도록 가능한 한 빨리 문제를 완화하기 위해 정보를 사용합니다.
- _TTR(수정_시간): 해결 시간을 측정하고 팀은 시간이 지남에 따라 개선하기 위해 노력합니다. 완화 후 팀은 문제가 재발하지 않도록 근본 원인에서 문제를 해결하는 방법을 고민합니다.

#### 2. 사용량을 추적

버전 간의 사용량 및 차이를 추적하면 팀에서 변경의 영향을 측정하고 비즈니스 의사 결정을 내릴 수 있습니다.

## 어떤 정보를 모니터링 해야 해?

### 1. 스프링 서버 매트릭 모니터링

1. 메모리 사용량:

- 중요성: 힙 사용량을 모니터링하면 메모리 누수나 과도한 메모리 사용을 감지할 수 있습니다. 메모리 부족이 발생하면 성능 저하나 애플리케이션 크래시로 이어질 수 있습니다.

2. CPU 사용량:

- 중요성: 높은 CPU 사용률은 성능 병목을 나타내며, CPU 자원을 최적화하여 응답 시간을 줄이는 데 도움을 줄 수 있습니다.

3. 평균 부하:

- 중요성: 시스템의 부하가 지나치게 높을 경우 성능 저하가 발생할 수 있으며, 서버의 안정성을 평가하는 데 유용합니다.

4. Connections Size:

- 중요성: 데이터베이스에 대한 연결이 부족하면 성능 문제가 발생할 수 있으며, 최대 연결 수를 초과하면 새로운 연결 요청이 대기하게 됩니다.

5. GC Count (Garbage Collection 횟수):

- 중요성: GC 횟수가 많으면 애플리케이션 성능에 부정적인 영향을 미칠 수 있으며, 메모리 관리 전략을 평가하는 데 중요합니다.

### 2. 로그 모니터링

1. 스프링 서버 로그
2. Nginx 로그

<br>

## 모니터링 툴 - Grafana

### Spring Boot Admin

스프링 부트 애플리케이션을 모니터링하고 관리하기 위한 도구로, 스프링 부트의 Actuator를 기반 작동

#### 장점

- 스프링 부트 애플리케이션과의 통합 용이
- Actuator를 통해 애플리케이션의 메트릭, 상태, 로그 등을 쉽게 모니터링 가능

#### 단점

- 기본적으로 제공되는 기능이 제한적이며, 사용자 정의 대시보드나 복잡한 시각화 기능은 부족

### CloudWatch

AWS에서 제공하는 모니터링 서비스

#### 장점

- AWS 서비스와의 원활한 통합 및 자동 메트릭 수집 기능 제공
- 경고 및 알림 기능이 뛰어남
- 다양한 시각화 옵션과 대시보드를 제공하여 메트릭을 쉽게 분석 가능

#### 단점

- AWS 환경에 종속적이며, 다른 클라우드 서비스나 온프레미스 환경에서는 사용이 어려움

### Grafana

오픈소스 데이터 시각화 및 분석 도구

#### 장점

- 다양한 데이터 소스와 통합 가능
- Prometheus, InfluxDB, Elasticsearch 등 다양한 데이터 소스를 지원하여 유연한 시각화 가능
- 사용자 정의 대시보드를 생성할 수 있으며, 다양한 시각화 옵션(차트, 그래프 등) 제공
- 실시간 데이터 시각화 및 알림 기능이 뛰어나며, 커스터마이징이 용이
- 문서 및 정보가 많음

#### 단점

- 자체적으로 메트릭을 수집하는 기능이 없으므로, 다른 도구와 함께 사용해야 함
- 초기 설정이 다소 복잡할 수 있으며, 데이터 소스 설정 필요

### 모니터링 툴 결정 - Grafana

**Grafana 사용으로 결정**

- 모니터링 대상이 제한되지 않음
- 다양한 시각화 옵션(차트, 그래프 등) 제공
- 알림 기능 제공
- 문서 및 정보가 많음

<br>

## 스프링 서버 매트릭 모니터링

- **Spring Actuator**: Spring 애플리케이션의 **메트릭 수집** 도구로, 애플리케이션 상태, 성능 지표, 시스템 상태 등의 정보를 노출함.
- **Prometheus**: Spring Actuator에서 노출된 **메트릭을 저장**하고, 이를 시계열 데이터로 수집해 모니터링 및 경고 시스템에 사용함.

### 매트릭이란?

시스템, 애플리케이션, 서비스의 성능과 상태를 측정하고 모니터링하기 위해 수집되는 데이터

보통 아래 정보들을 말합니다.

1. 성능 지표: 요청 처리 시간, 메모리 사용량, CPU 사용률 등 애플리케이션의 성능을 나타내는 지표
2. 상태 정보: 애플리케이션의 현재 상태, 예를 들어 활성화된 세션 수, 처리 중인 요청 수 등
3. 사용자 정의 지표: 개발자가 특정 비즈니스 로직이나 요구 사항에 따라 정의한 지표

### 스프링 매트릭 수집 방법 - 스프링 액추에이터

스프링에서 제공하는 Spring Boot Actuator를 통해 스프링 애플리케이션의 매트릭을 쉽게 수집하고 모니터링 할 수 있다.

#### Micrometer

다양한 모니터링 시스템이 많은데 각**모니터링 시스템마다 원하는 메트릭의 형태가 다르다.**

Micrometer는 이 매트릭을 추상화했기 때문에, 사용할 모니터링 시스템에 맞는 Micrometer 구현체를 사용하면 그 시스템에 맞는 매트릭을 제공해준다.

그러면 , 애플리케이션의 메트릭을 Micrometer가 정한 표준 방법으로 모아서 제공해준다.

### 스프링 매트릭 저장 방법 - Prometheus

#### 1. Prometheus

간편한 설정과 강력한 쿼리 언어를 제공하지만, 데이터 보존 기간이 짧고 수평 확장성이 부족

##### 장점:

- 자체 스토리지: Prometheus는 자체적인 시간 시계열 데이터베이스를 제공하여 설치 및 설정 간편
- 고급 쿼리 언어: PromQL을 사용하여 매트릭을 효율적으로 쿼리 가능
- 자동 스크래핑: HTTP 엔드포인트를 통해 자동으로 매트릭 수집
- 경고 기능: 경고 규칙을 설정하여 특정 조건을 기반 알림 기능

##### 단점:

- 데이터 보존 기간: 기본적으로 데이터 보존 기간이 짧아(일반적으로 15일) 장기간 저장에는 적합하지 않음
- 수평 확장성 부족: 단일 인스턴스에서 실행되므로 대규모 환경에서는 수평 확장이 어려움
- 복잡한 쿼리: PromQL이 강력하지만, 복잡한 쿼리를 작성하기에는 학습 곡선이 있을 수 있음

#### 2. InfluxDB

장기 보존과 수평 확장이 가능하지만, 초기 설정이 복잡하고 상용 버전에서 비용이 발생할 수 있음

##### 장점:

- 장기 보존: 데이터 보존 기간을 유연하게 설정할 수 있어 장기 저장에 적합
- 수평 확장성: 클러스터 모드로 구성할 수 있어 수평 확장이 용이
- 쉬운 쿼리: InfluxQL을 사용하여 SQL과 유사한 방식으로 쿼리를 작성할 수 있어 직관적
- 데이터 압축: 데이터 압축 기능이 있어 스토리지 효율성을 높일 수 있음

##### 단점:

- 설정 복잡도: 초기 설정 및 구성 과정이 Prometheus보다 복잡할 수 있음
- 비용: 상용 버전인 InfluxDB Cloud를 사용할 경우 비용이 발생할 수 있음
- 쓰기 성능 제한: 대량의 데이터를 동시에 쓰기에는 성능이 제한적일 수 있음

#### 3. Graphite

안정성과 쉬운 설치가 장점이지만, 쿼리 언어와 데이터 보존 관리는 상대적으로 제한적

##### 장점:

- 오랜 역사: 안정성이 높고, 많은 커뮤니티 지원이 있음
- 다양한 시각화 도구: Grafana와 같은 도구와 잘 통합되어 매트릭 시각화가 용이
- 쉬운 설치: 비교적 간단하게 설치하고 설정할 수 있음

##### 단점:

- 쿼리 언어: 쿼리 언어가 상대적으로 제한적이며, 복잡한 쿼리를 작성하기 어려울 수 있음
- 데이터 보존 관리: 데이터 보존 정책을 관리하는 것이 Prometheus나 InfluxDB보다 복잡할 수 있음
- 확장성 부족: 수평 확장이 어려워 대규모 환경에서는 한계가 있을 수 있음

#### 스프링 매트릭 저장 방법 결정 - Prometheus

**Prometheus 사용으로 결정**

간편한 초기 설정과 다양한 기능이 존재한다는 점에서 선택

### 매트릭 모니터링 방법

#### EC2 서버에 Prometheus 설정

1. Prometheus 설정 파일(prometheus.yml)을 생성
2. Prometheus Docker 컨테이너를 실행합니다.
3. /prometheus 로 접속 시

#### EC2 서버에 Grafana 설정

- Grafana Docker 컨테이너를 실행
- Grafana에 Prometheus 데이터 소스를 추가
- 대시보드를 생성하거나 임포트합니다.

<br>

## 로그 모니터링

- **Promtail**: 로그를 **수집**하는 도구. 다양한 시스템의 로그 파일에서 데이터를 읽고 라벨을 붙여 Loki로 전송함.
- **Loki**: 수집된 로그를 **저장**하고, 필요한 로그 데이터를 쿼리할 수 있는 로그 집계 및 검색 시스템.

### 로그 수집 방법 - Promtail

#### 1. Promtail

로그를 수집하여 Loki에 전달하는 경량 도구로, 간편한 설정과 유연한 파이프라인 구성이 가능하지만, 고급 기능이 부족할 수 있음

##### 장점:

- 간단한 설정: YAML 파일로 쉽게 설정 가능
- 라벨링 기능: 수집된 로그에 메타데이터(라벨) 추가 가능
- 정규 표현식 지원: 로그 형식에 맞춰 데이터 추출 및 변환 가능
- 다양한 로그 소스 지원: 파일 시스템, 시스템 로그 등 다양한 소스에서 로그 수집

##### 단점:

- 고급 처리 기능 부족: 복잡한 데이터 처리에 제한적일 수 있음
- 대규모 환경에서의 관리: 수많은 인스턴스를 관리하기 어려울 수 있음

#### 2. Fluentd

다양한 데이터 소스와의 통합이 용이하며, 데이터 변환과 라우팅 기능이 뛰어나지만, 설정이 복잡할 수 있음

##### 장점:

- 플러그인 지원: 500개 이상의 플러그인으로 다양한 데이터 수집 가능
- 클라우드 친화적: 클라우드 및 하이브리드 환경에서의 로그 수집에 적합
- 데이터 라우팅: 수집한 로그를 다양한 목적지로 전송 가능

##### 단점:

- 설정 복잡성: 많은 플러그인으로 인해 초기 설정 및 관리가 복잡할 수 있음
- 성능 이슈: 대량의 로그를 처리할 때 성능 최적화가 필요할 수 있음

#### 3. Filebeat

가벼운 로그 전송 도구로, 실시간 로그 전송에 최적화되어 있지만, 기능이 제한적일 수 있음

##### 장점:

- 가벼운 리소스 사용: 최소한의 리소스로 로그 전송 가능
- 간단한 설정: 빠르고 쉽게 설정하여 로그 수집 가능
- 실시간 로그 전송: 빠른 속도로 로그를 수집하고 전송할 수 있음

##### 단점:

- 제한된 기능: 로그 수집에 최적화되어 있지만 복잡한 처리에는 부적합
- 확장성 부족: 대규모 환경에서는 별도의 확장이 필요할 수 있음

#### 로그 수집 방법 결정 - Promtail

**Promtail 사용으로 결정**

- 간편한 사용법 및 loki라는 로그 저장 툴과의 통합을 위해 설계된 로그 수집 툴이어서 로그 저장 툴과 연결도 쉽다

### 로그 저장 방법 - Loki

Loki는 Grafana의 로그 수집 및 저장 시스템으로, 특히 Kubernetes 환경에서 로그를 관리하기에 최적화되어 있습니다. 다음은 Loki의 주요 장점과 단점입니다.

#### 장점

1. Kubernetes 친화적: Kubernetes 환경에 최적화되어 있어, 서비스 간 로그 수집 및 관리 용이
2. 단순한 아키텍처: 복잡한 로그 파싱 없이 원본 로그를 그대로 저장하여 관리 간편
3. Grafana 통합: Grafana와 쉽게 통합되어 실시간 로그 모니터링과 시각화 지원
4. 비용 효율성: 상대적으로 낮은 비용으로 운영할 수 있으며, 데이터 압축 기능이 있어 스토리지 효율이 높음

#### 단점

1. 기능 제한: Elasticsearch와 같은 고급 기능에 비해 기능이 제한적이며 복잡한 쿼리 지원 부족
2. 데이터 정합성: 로그의 구조가 일관되지 않을 경우 데이터 검색이 복잡해질 수 있음
3. 신뢰성 문제: 새로운 시스템이기 때문에 대규모 프로덕션 환경에서의 신뢰성에 대한 검증 필요

