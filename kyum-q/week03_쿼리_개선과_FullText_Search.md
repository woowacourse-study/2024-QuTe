
# 사용 이유

쿼리 속도를 측정하고 속도 개선을 위해 방법을 찾아봤다.
그래서 쿼리 개선 및 Full Text Search를 사용하였다.

<br>

# 쿼리 개선

## 커버링 인덱스

쿼리를 충족시키는 데 필요한 모든 데이터를 갖고 있는 인덱스를 커버링 인덱스 (Covering Index 혹은 Covered Index)라 한다.
SELECT, WHERE, ORDER BY, GROUP BY 등에 사용되는 모든 컬럼이 인덱스의 구성요소인 경우를 말한다.

## IN 절 vs 서브 쿼리

SQL에서 데이터 조회를 할 때, `IN` 절을 사용하는 방법과 서브쿼리를 사용하는 방법이 있다.

**IN 절 사용**: `IN (1, 2, 5, 8)`처럼 직접 값 목록을 나열하는 방식은 데이터셋이 작을 때 효율적이다. 이 방식은 직관적이며 성능이 뛰어나다.

**서브쿼리 사용**: 반면, `IN (SELECT ...)`와 같은 서브쿼리는 데이터셋이 클 때 더 유리하다. 서브쿼리는 동적으로 데이터를 필터링하여 인덱스가 적용된 열에서 효율적으로 조회할 수 있도록 해준다.


작은 데이터셋에서는 `IN` 절이 좋지만, 큰 데이터셋에서는 서브쿼리가 성능을 향상시킬 수 있다. 데이터의 특성과 크기에 따라 적절한 방법을 선택하는 것이 중요하다.

## N+1 개선

N+1 문제 : ORM 기술에서 특정 객체를 대상으로 수행한 쿼리가 해당 객체가 가지고 있는 연관 관계 또한 조회하게 되면서 N번의 추가적인 쿼리가 발생하는 문제

### 조회 최적화

개수에 비례하여 쿼리를 반복 실행하면 성능 저하가 발생한다. 이를 해결하기 위해 관련된 조회 로직을 통합하여 중복된 데이터를 한 번에 가져온다. 이러한 방법은 데이터베이스 호출 수를 줄이고, 필요한 정보를 효율적으로 필터링함으로써 성능을 개선한다. 최적화된 접근 방식은 전체 쿼리 성능을 크게 향상시키는 데 기여한다.

### Fetch Join

Fetch Join은 Root Entity에 대해서 조회 할 때 Lazy Loading 으로 설정 되어있는 연관관계를 Join쿼리를 발생시켜 한번에 조회할 수 있는 기능이다. 
Fetch Join을 사용하면 한 번의 쿼리로 주 객체와 관련된 모든 객체를 동시에 가져와 데이터베이스 호출 수를 크게 줄이고, 성능을 개선할 수 있습니다. 이렇게 하면 전체적인 응답 시간이 단축되고, 더 효율적인 데이터 처리가 가능합니다.

<br>

## 개선한 쿼리 : 태그 조회 쿼리

> 관련 위키 : [쿼리 성능 개선 ‐ 태그 조회](https://github.com/woowacourse-teams/2024-code-zap/wiki/%EC%BF%BC%EB%A6%AC-%EC%84%B1%EB%8A%A5-%EA%B0%9C%EC%84%A0-%E2%80%90-%ED%83%9C%EA%B7%B8-%EC%A1%B0%ED%9A%8C)

커버링 인덱스 적용 + IN 절 대신 서브 쿼리 + N+1 개선

- **커버링 인덱스 적용**: 멤버의 템플릿 ID만 조회하는 방식으로 수정하여 커버링 인덱스를 사용.
- **IN 절 대신 서브 쿼리 사용**: 서브 쿼리를 통해 IN 절 성능을 개선.
- **N+1 개선**: 템플릿과 태그를 조회하는 로직을 결합해 태그 테이블 조회 수를 줄여 N+1 문제 해결.

### 개선 전 속도

5268ms

### 개선 후 속도

92ms

<br>

# Full Text Search

FullText Search는 단어나 구문에 대한 검색을 지원하고자 제공되는 방식이다.

검색하고자 하는 column에 FullText Index를 설정해주면, 문자열이 정해진 방법으로 분리되어 인덱스를 생성하고, 이를 빠르게 검색할 수 있다.

## FullText Index

FullText Search에서 인덱스를 생성하는 방법은 여러가지 있다.

인덱스는 파서가 문자열을 토크나이징한 후에 생성하게 된다. 이런 역할을 수행하는 파서 중 Built-in parser와 N-gram parser를 이야기한다.

### 파서

#### Built-In Parser


Built-In Parser는 stopword(구분자)를 기준으로 키워드를 추출하는 방식이다. 
공백이나 문장 기호 혹은 사용자가 지정한 특정 단어를 기준으로 토크나이징하게 된다.

FullText Search는 토큰과 검색 키워드가 전부 일치하거나 전방(prefix) 일치한 경우에만 결과를 가져온다.

> 예를 들어서, 구분자가 공백이라면 문장이 다음과 같이 쪼개집니다.
> 켬미는 우테코에서 코드잽을 개발했다 -> 켬미는 / 우테코에서 / 코드잽을 / 개발했다 
> 
> 위와 같은 방식으로 토크나이징 되어 있다면 “켬미” 혹은 “코드잽” 과 같은 검색 키워드로는 위 문장을 검색할 수 없다.

#### N-gram Parser

N-gram 파서는 지정된 토큰 사이즈를 기준으로 키워드를 추출합니다.
Space Handling : N-gram 파서는 공백이 포함된 경우 키워드로 추출하지 않는다.

FullText Index를 설정해줄 때 옵션으로 지정해주기만 하면 사용할 수 있다.

> 예를 들어서, 토큰 사이즈가 2 라면 문장이 다음과 같이 쪼개집니다.
> 켬미는 우테코에서 코드잽을 개발했다 -> 켬미 / 미는 / 는우 / 우테 / 테코 / 코에 / ... / 발했 / 했다
> 
> 이제 "켬미" 와 "코드잽" (코드/드잽) 같은 검색 키워드도 검색할 수 있다.

<br>

### MATCH (…) AGAINST (…)

FullText Index가 걸려있는 column에 한해서 MATCH (…) AGAINST (…)를 사용해서 검색을 이용할 수 있다.
검색 시 검색 방식을 설정할 수 있다.

### 검색 방식 : Search Type

#### IN NATURAL LANGUAGE MODE

- 해당 모드는 검색 키워드를 토큰 사이즈로 분리한 후, 분리된 단어 중에서 하나라도 포함되는 데이터를 찾는다.
- 해당 모드는 검색 방식을 생략해서 적었을 때 기본 모드이다.

#### IN BOOLEAN MODE

- 해당 모드는 검색 키워드를 토큰 사이즈로 분리한 후, 추가적인 검색 규칙을 적용해서 단어가 포함되는 데이터를 찾는다.

```sql
SELECT ... 
FROM ... 
WHERE MATCH(column) AGAINST('+A -B' IN BOOLEAN MODE); # A는 포함 B는 포함하지 않는 데이터
```

이외에도 여러 가지 검색 규칙이 있다.

| Operator | Description                         |
| -------- | ----------------------------------- |
| +        | 반드시 포함하는 단어                         |
| –        | 반드시 제외하는 단어                         |
| >        | 포함하면서 검색 순위를 높일 단어                  |
| <        | 포함하지만 검색 순위를 낮출 단어                  |
| ()       | 하위 표현식으로 그룹화                        |
| ~        | '-' 연산자와 비슷하지만 제외 시키지는 않고 검색 조건을 낮춤 |
| *        | 와일드카드                               |
| “”       | 구문 정의                               |
### Relevance : 자동 정렬

- MATCH (…) AGAINST (…)은 검색 키워드가 얼마나 많이 포함되어 있는 지에 따라서 관련성(relevance)이 결정된다. 관련성을 정렬해서 사용자에게 더욱 적절한 검색 결과를 보여줄 수도 있다.
- WHERE에 MATCH (…) 를 사용하면 반환된 row는 다음 조건이 충족하는 한 가장 관련성이 높은 항목부터 자동으로 정렬된다.
- 명시적인 ORDER BY가 없어야 한다.
- Table Scan이 아닌 FullText Index Scan을 사용해 검색을 수행해야 한다.
- 쿼리가 테이블을 조인하는 경우 FullText Index Scan 은 조인에서 가장 왼쪽에 있는 non-constant table 이어야 한다.

<br>

## 개선한 쿼리 : 템플릿 검색

> 관련 위키 : [쿼리 성능 개선 ‐ 템플릿 검색](https://github.com/woowacourse-teams/2024-code-zap/wiki/%EC%BF%BC%EB%A6%AC-%EC%84%B1%EB%8A%A5-%EA%B0%9C%EC%84%A0-%E2%80%90-%ED%85%9C%ED%94%8C%EB%A6%BF-%EA%B2%80%EC%83%89)

### 개선 전

259.67ms

### 개선 후

83.27ms