## 웹 보안을 위한 쿠키 옵션

### XSS(Cross-Site-Scripting) 공격과 방어 전략

공격자가 웹 페이지에 `악성 스크립트를 삽입`하여 사용자의 브라우저에서 실행되게 만드는 공격이다. 웹 애플리케이션이 사용자로부터 입력 받은 값을 제대로 검사하지 않고 사용할 경우 발생한다. 결과로 사용자는 의도치 않은 동작을 수행하거나 쿠키, 세션 등의 정보를 탈취당하게 된다. 악성 스크립트를 삽입한다는 것이 잘 이해가 안 되서 [XSS 공격의 예제 코드](https://dj-min43.medium.com/xss-%EA%B3%B5%EA%B2%A9%EC%9D%84-%EC%A7%81%EC%A0%91-%ED%95%B4%EB%B3%B4%EB%A9%B4%EC%84%9C-%EC%95%8C%EC%95%84%EB%B3%B4%EA%B8%B0-c2c1d9baf7ec)를 보면서 이해했다. 쿠키의 `httpOnly 옵션`을 통해 자바스크립트로(document.cookie) 쿠키에 직접 접근해서 쿠키 정보를 읽어오는 것을 방지할 수 있다.

### CSRF(Cross-Site-Request-Forgery) 공격과 방어 전략

사용자가 자신의 의지와 무관하게 `공격자가 의도한 행위를 서버에 요청`하게 만드는 공격이다. 사용자의 권한을 이용해 서버에 대한 악성 공격을 한다. 예를 들어 공격자가 자신에게 돈을 송금하도록 송금 전송에 대한 요청을 조작하고자 한다. 공격자는 송금 전송에 대한 스크립트를 삽입한 링크를 게시판이나 메일을 통해 사용자에게 노출시킨다. 사용자가 해당 링크를 클릭하는 순간 요청이 서버로 전달되고 서버는 사용자를 신뢰하기 때문에 공격자에게 돈을 송금한다. XSS 요청은 `사용자가 특정 사이트를 신뢰`하기 때문에 발생하는 문제라면, CSRF는 `특정 사이트가 사용자를 신뢰`하기 때문에 발생하는 문제이다. 쿠키의 `sameSite 옵션`을 통해 다른 사이트에서의 요청을 차단할 수 있다.

## SameSite 옵션

SameSite는 크게 3가지 값을 설정할 수 있다.

- Strict : 반드시 같은 사이트에서만 사용 가능하다.
- Lax : 같은 사이트에서 사용 가능하지만, 유저가 링크를 클릭해서 접속하거나 하는 경우에는 다른 사이트에서 사용 가능하다.
- None : 다른 사이트에서도 사용 가능하지만 반드시 Secure 옵션과 함께 사용해야 한다.

### 크롬의 Same-Site-Policy

쿠키에도 Third-Party Cookie라는 개념이 있다. 요청을 보내는 쪽과 받는 쪽의 사이트가 다른 경우를 지정하는 쿠키를 3자 쿠키(Third-Party Cookie)라고 한다. 구글 크롬에서는 2020년 쿠키의 기본 동작에 대한 변경을 발표했는데, 과거에는 아무런 옵션을 지정하지 않아도 다른 사이트에서 쿠키를 보낼 수 있었다. 하지만 이제는 3자 쿠키를 사용하려면 반드시 `SameSite=None` 옵션과 `Secure`라는 옵션을 쿠키에 설정해 주어야 한다. 또한 지정하지 않으면 기본 설정은 `SameSite=Lax`이다.

### Site 개념

**💡 Same-Site**

사이트는 도메인 네임과 탑레벨 도메인으로 구성된다. 위의 예시에서 [dev-fe.example.com](http://dev.example.com) 과 [dev.example.com](http://dev.example.com) 는 같은 도메인 네임과 탑레벨 도메인이 같기 때문에 같은 사이트라고 한다.

**💡 Same-Origin**

혼동할 수 있는 개념으로 Origin(출처)이라는 개념이 있는데, Origin은 주로 CORS관련해서 등장하는 개념이다. Origin은 프로토콜, 호스트 네임, 포트가 모두 같아야지 같은 출처로 판단한다. 여기서 위의 두 개념은 서브도메인이 다르기 때문에 다른 출처이다.

## Domain 옵션

Domain 옵션은 요청을 보낼 호스트를 지정하는 것이다. 기본값이 무엇인지 확인하기 위해 domain 옵션을 빼고 보내니 기본값은 쿠키를 생성하는 서버의 도메인으로 설정되었다. 즉 도메인만으로는 CSRF 공격을 막을 수 없다.